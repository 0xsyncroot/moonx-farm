# =============================================================================
# MoonXFarm WebSocket Service - Nginx Configuration (Optimized for WebSocket)
# =============================================================================
# Domain: ws.moonx.farm
# WebSocket Path: /ws
# Optimized for high-performance WebSocket connections
# =============================================================================

# Upstream configuration for WebSocket service
upstream websocket_backend {
    # WebSocket service instances
    server localhost:3008 max_fails=3 fail_timeout=30s;
    
    # Add more instances for load balancing
    # server localhost:3009 max_fails=3 fail_timeout=30s;
    # server localhost:3010 max_fails=3 fail_timeout=30s;
    
    # Load balancing method for WebSocket
    ip_hash;  # Sticky sessions for WebSocket (recommended)
    
    # Connection pooling for better performance
    keepalive 100;
    keepalive_requests 1000;
    keepalive_timeout 300s;
}

# Rate limiting zones (relaxed for WebSocket)
limit_req_zone $binary_remote_addr zone=websocket_limit:10m rate=50r/s;
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
limit_conn_zone $binary_remote_addr zone=websocket_conn:10m;

# Map for WebSocket upgrade
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# HTTPS Server (Production)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ws.moonx.farm;

    # =============================================================================
    # SSL Configuration
    # =============================================================================
    ssl_certificate /etc/nginx/ssl/ws.moonx.farm.crt;
    ssl_certificate_key /etc/nginx/ssl/ws.moonx.farm.key;
    
    # SSL Security
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # HSTS (Optional - enable for production)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # =============================================================================
    # Security Headers
    # =============================================================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' ws: wss: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' ws: wss: https:; media-src 'self' https:; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

    # =============================================================================
    # Rate Limiting (Relaxed for WebSocket performance)
    # =============================================================================
    limit_req zone=websocket_limit burst=100 nodelay;
    limit_conn websocket_conn 500;

    # =============================================================================
    # Logging
    # =============================================================================
    access_log /var/log/nginx/ws.moonx.farm.access.log combined;
    error_log /var/log/nginx/ws.moonx.farm.error.log warn;

    # =============================================================================
    # WebSocket Proxy Configuration (Optimized for Performance)
    # =============================================================================
    location /ws {
        # WebSocket-specific configuration
        proxy_pass http://websocket_backend;
        proxy_http_version 1.1;
        
        # WebSocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket timeouts (no limits for persistent connections)
        proxy_connect_timeout 60s;
        proxy_send_timeout 0;
        proxy_read_timeout 0;
        
        # Buffer settings for WebSocket
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        
        # NO rate limiting for WebSocket connections (maximum performance)
        # limit_req zone=websocket_limit burst=10 nodelay;
        # limit_conn websocket_conn 20;
        
        # CORS headers for WebSocket
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control, Pragma, Expires, Sec-WebSocket-Protocol, Sec-WebSocket-Key, Sec-WebSocket-Version" always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Credentials true always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control, Pragma, Expires, Sec-WebSocket-Protocol, Sec-WebSocket-Key, Sec-WebSocket-Version" always;
            add_header Access-Control-Max-Age 86400 always;
            add_header Content-Length 0 always;
            add_header Content-Type "text/plain; charset=utf-8" always;
            return 204;
        }
    }

    # =============================================================================
    # Health Check Endpoint
    # =============================================================================
    location /health {
        proxy_pass http://websocket_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache health check for 10 seconds
        proxy_cache_valid 200 10s;
        proxy_cache_valid 404 1m;
        proxy_cache_valid any 1m;
        
        # Rate limiting for health checks
        limit_req zone=api_limit burst=5 nodelay;
        
        # Health check specific headers
        add_header X-Health-Check "websocket-service" always;
    }

    # =============================================================================
    # API Documentation (Optional)
    # =============================================================================
    location /docs {
        proxy_pass http://websocket_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Rate limiting for docs
        limit_req zone=api_limit burst=10 nodelay;
        
        # Optional: Restrict access to docs
        # allow 192.168.1.0/24;
        # deny all;
    }

    # =============================================================================
    # Metrics Endpoint (Optional)
    # =============================================================================
    location /metrics {
        proxy_pass http://websocket_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Restrict access to metrics
        allow 127.0.0.1;
        allow 192.168.1.0/24;
        allow 10.0.0.0/8;
        deny all;
    }

    # =============================================================================
    # Static Files (if any)
    # =============================================================================
    location /static/ {
        alias /var/www/websocket-static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        gzip_static on;
    }

    # =============================================================================
    # Security - Block common attacks
    # =============================================================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~* \.(sql|bak|backup|old|tmp)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # =============================================================================
    # Default location - redirect to WebSocket
    # =============================================================================
    location / {
        return 301 https://$server_name/ws;
    }
}

# HTTP Server (Redirect to HTTPS)
server {
    listen 80;
    listen [::]:80;
    server_name ws.moonx.farm;
    
    # Security headers even for HTTP
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # Rate limiting
    limit_req zone=api_limit burst=10 nodelay;
    
    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# =============================================================================
# WebSocket Optimized Configuration Notes:
# =============================================================================
# 1. SSL Certificates:
#    - Place your SSL certificates in /etc/nginx/ssl/
#    - ws.moonx.farm.crt (certificate)
#    - ws.moonx.farm.key (private key)
#
# 2. Log Files:
#    - Access logs: /var/log/nginx/ws.moonx.farm.access.log
#    - Error logs: /var/log/nginx/ws.moonx.farm.error.log
#
# 3. Rate Limiting (Relaxed for WebSocket Performance):
#    - WebSocket connections: 50 requests/second, burst 100
#    - API calls: 100 requests/second, burst 50
#    - Connection limit: 500 per IP for server, NO LIMIT for /ws
#
# 4. WebSocket Connection:
#    - URL: wss://ws.moonx.farm/ws
#    - Supports all WebSocket protocols
#    - NO timeout limits for persistent connections
#    - Optimized for high-frequency trading and real-time data
#
# 5. Health Check:
#    - URL: https://ws.moonx.farm/health
#    - Cached for 10 seconds
#
# 6. Load Balancing:
#    - Uses ip_hash for sticky sessions (required for WebSocket)
#    - Add more upstream servers for horizontal scaling
#    - Connection pooling with 100 keepalive connections
#
# 7. Performance Optimizations:
#    - NO rate limiting on WebSocket path
#    - Proxy buffering disabled
#    - Request buffering disabled
#    - Infinite read/send timeouts for persistent connections
#    - Large connection pools and burst limits
#
# 8. Security:
#    - CORS configured for WebSocket
#    - Basic security headers
#    - SSL/TLS encryption
#    - Common attack vectors blocked
# =============================================================================

# =============================================================================
# Usage Examples:
# =============================================================================
# WebSocket Connection:
#   const ws = new WebSocket('wss://ws.moonx.farm/ws');
#
# Health Check:
#   curl https://ws.moonx.farm/health
#
# Load Testing:
#   - No artificial limits on WebSocket connections
#   - Supports thousands of concurrent connections
#   - Optimized for high-frequency real-time data
# ============================================================================= 