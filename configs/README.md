# MoonX Farm DEX - Configuration Manager

H·ªá th·ªëng qu·∫£n l√Ω c·∫•u h√¨nh t·∫≠p trung cho to√†n b·ªô monorepo MoonX Farm DEX. Cho ph√©p m·ªói service ch·ªâ load nh·ªØng configuration c·∫ßn thi·∫øt v·ªõi h·ªó tr·ª£ RPC fallback v√† private RPC URLs.

## üéØ T√≠nh nƒÉng

- **Configuration Profiles**: M·ªói service ch·ªâ load config c·∫ßn thi·∫øt
- **Type Safety**: Validation v·ªõi Zod schema
- **Environment Variables**: Qu·∫£n l√Ω t·∫≠p trung t·ª´ file `.env` root
- **RPC Management**: H·ªó tr·ª£ private RPC v√† fallback RPC URLs
- **Flexible Usage**: D·ªÖ d√†ng extend v√† customize cho t·ª´ng service
- **Validation**: Ki·ªÉm tra config b·∫Øt bu·ªôc cho t·ª´ng service

## üìÅ C·∫•u tr√∫c

```
configs/
‚îú‚îÄ‚îÄ index.ts          # Main config manager & profiles
‚îú‚îÄ‚îÄ schemas.ts        # Zod schemas cho validation
‚îú‚îÄ‚îÄ utils.ts          # Utility functions & RPC management
‚îú‚îÄ‚îÄ example.ts        # Usage examples
‚îú‚îÄ‚îÄ package.json      # @moonx/configs
‚îú‚îÄ‚îÄ tsconfig.json     # TypeScript config
‚îî‚îÄ‚îÄ README.md         # Documentation
```

## üöÄ S·ª≠ d·ª•ng

### 1. T·∫°o file .env ·ªü root project

```bash
# Copy t·ª´ env.example
cp env.example .env

# ƒêi·ªÅn c√°c gi√° tr·ªã th·ª±c t·∫ø
nano .env
```

### 2. S·ª≠ d·ª•ng trong service

#### Auth Service
```typescript
import { createAuthServiceConfig, getDatabaseConfig, getRedisConfig, getJwtConfig } from '@moonx/configs';

// T·∫°o config cho auth service
const config = createAuthServiceConfig();

// L·∫•y database config
const dbConfig = getDatabaseConfig('auth-service');
console.log(dbConfig.host); // localhost

// L·∫•y Redis config
const redisConfig = getRedisConfig('auth-service');
console.log(redisConfig.port); // 6379

// L·∫•y JWT config
const jwtConfig = getJwtConfig('auth-service');
console.log(jwtConfig.secret); // your-jwt-secret
```

#### Quote Service v·ªõi RPC Management
```typescript
import { 
  createAggregatorServiceConfig, 
  getRedisConfig, 
  getApiKeys, 
  getNetworkConfigs,
  getRpcConfig,
  getBestRpcUrl 
} from '@moonx/configs';

const config = createAggregatorServiceConfig();

// Redis cho caching
const redisConfig = getRedisConfig('aggregator-service');

// API keys cho external services
const apiKeys = getApiKeys('aggregator-service');
console.log(apiKeys.coingecko); // your-coingecko-api-key

// Blockchain networks v·ªõi RPC management
const networks = getNetworkConfigs('aggregator-service');
const baseMainnet = networks.base.mainnet;

// L·∫•y RPC URL t·ªët nh·∫•t (private tr∆∞·ªõc, fallback sau)
const bestRpcUrl = getBestRpcUrl(baseMainnet);
console.log('Best RPC URL:', bestRpcUrl);

// Ho·∫∑c s·ª≠ d·ª•ng RPC config helper
const rpcConfig = getRpcConfig('aggregator-service', 'base', 'mainnet');
console.log('Private RPC:', rpcConfig.privateRpc);
console.log('Fallback RPCs:', rpcConfig.fallbackRpcs);
console.log('Best URL:', rpcConfig.getBestUrl());
```

#### Swap Orchestrator v·ªõi RPC Fallback
```typescript
import { 
  createSwapOrchestratorConfig, 
  getDatabaseConfig, 
  getRedisConfig, 
  getKafkaConfig,
  getTradingConfig,
  getAllRpcUrls 
} from '@moonx/configs';

const config = createSwapOrchestratorConfig();

// Database
const dbConfig = getDatabaseConfig('swap-orchestrator');

// Redis
const redisConfig = getRedisConfig('swap-orchestrator');

// Kafka
const kafkaConfig = getKafkaConfig('swap-orchestrator');

// Trading parameters
const tradingConfig = getTradingConfig('swap-orchestrator');
console.log(tradingConfig.defaultSlippageTolerance); // 0.5

// RPC URLs cho fallback
const networks = getNetworkConfigs('swap-orchestrator');
const baseAllRpcs = getAllRpcUrls(networks.base.mainnet);
console.log('All Base RPCs:', baseAllRpcs); // [privateRpc, fallback1, fallback2, ...]
```

### 3. RPC Management

#### Private RPC vs Fallback RPCs
```typescript
import { getRpcConfig, hasPrivateRpc, getPublicRpcUrls } from '@moonx/configs';

const rpcConfig = getRpcConfig('aggregator-service', 'base', 'mainnet');

// Ki·ªÉm tra c√≥ private RPC kh√¥ng
if (rpcConfig.hasPrivate()) {
  console.log('Using private RPC for high-speed operations');
  // S·ª≠ d·ª•ng private RPC cho operations c·∫ßn t·ªëc ƒë·ªô
} else {
  console.log('Using public fallback RPCs');
  // S·ª≠ d·ª•ng fallback RPCs
}

// L·∫•y ch·ªâ public RPC URLs
const publicRpcs = rpcConfig.getPublicUrls();
console.log('Public RPCs:', publicRpcs);
```

#### Fallback Implementation
```typescript
import { getAllRpcUrls } from '@moonx/configs';

const networks = getNetworkConfigs('swap-orchestrator');
const baseAllRpcs = getAllRpcUrls(networks.base.mainnet);

// Th·ª≠ t·ª´ng RPC URL theo th·ª© t·ª±
for (const rpcUrl of baseAllRpcs) {
  try {
    console.log(`Trying RPC: ${rpcUrl}`);
    
    // Th·ª±c hi·ªán RPC call
    const response = await fetch(rpcUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jsonrpc: '2.0',
        method: 'eth_blockNumber',
        params: [],
        id: 1
      })
    });
    
    if (response.ok) {
      console.log(`‚úÖ RPC ${rpcUrl} is working`);
      return rpcUrl; // S·ª≠ d·ª•ng RPC URL n√†y
    }
  } catch (error) {
    console.log(`‚ùå RPC ${rpcUrl} failed:`, error.message);
    continue; // Th·ª≠ RPC URL ti·∫øp theo
  }
}

throw new Error('All RPC URLs failed');
```

## üìã Configuration Profiles

### Available Profiles

| Profile | Description | Includes |
|---------|-------------|----------|
| `api-gateway` | API Gateway service | Base, Services, JWT, Redis |
| `auth-service` | Authentication service | Base, Database, Redis, JWT |
| `wallet-registry` | Wallet management | Base, Database, Blockchain |
| `aggregator-service` | Price quotes | Base, Redis, External APIs, Blockchain |
| `swap-orchestrator` | Trade execution | Base, Database, Redis, Kafka, Blockchain, Trading |
| `position-indexer` | Portfolio tracking | Base, Database, Redis, Kafka, Blockchain |
| `notify-service` | Notifications | Base, Redis, Kafka |
| `price-crawler` | Price aggregation worker | Base, Redis, Kafka, External APIs, Blockchain |
| `order-executor` | Order processing worker | Base, Database, Redis, Kafka, Blockchain, Trading |
| `web` | Frontend Next.js app | Base, Frontend |
| `full` | Full configuration | All schemas |

### Profile Usage

```typescript
import { createConfig } from '@moonx/configs';

// T·∫°o config cho service c·ª• th·ªÉ
const authConfig = createConfig('auth-service');
const aggregatorConfig = createConfig('aggregator-service');
const webConfig = createConfig('web');

// Ho·∫∑c s·ª≠ d·ª•ng helper functions
import { 
  createAuthServiceConfig,
  createAggregatorServiceConfig,
  createWebConfig 
} from '@moonx/configs';

const authConfig = createAuthServiceConfig();
const aggregatorConfig = createAggregatorServiceConfig();
const webConfig = createWebConfig();
```

## üîß Configuration Schemas

### Base Configuration
```typescript
NODE_ENV: 'development' | 'production' | 'test'
LOG_LEVEL: 'error' | 'warn' | 'info' | 'debug'
APP_NAME: string
APP_VERSION: string
```

### Database Configuration
```typescript
DATABASE_HOST: string
DATABASE_PORT: number
DATABASE_NAME: string
DATABASE_USER: string
DATABASE_PASSWORD: string
DATABASE_SSL: boolean
DATABASE_MAX_CONNECTIONS: number
DATABASE_IDLE_TIMEOUT_MS: number
DATABASE_CONNECTION_TIMEOUT_MS: number
```

### Redis Configuration
```typescript
REDIS_HOST: string
REDIS_PORT: number
REDIS_PASSWORD?: string
REDIS_DB: number
REDIS_KEY_PREFIX: string
REDIS_ENABLE_READY_CHECK: boolean
REDIS_LAZY_CONNECT: boolean
REDIS_MAX_RETRIES_PER_REQUEST: number
REDIS_CONNECT_TIMEOUT: number
REDIS_COMMAND_TIMEOUT: number
```

### Blockchain Configuration
```typescript
// Base Mainnet
BASE_MAINNET_RPC?: string (private RPC URL)
BASE_MAINNET_FALLBACK_RPCS: string (comma-separated public RPCs)
BASE_MAINNET_CHAIN_ID: number
BASE_MAINNET_EXPLORER: string

// Base Testnet
BASE_TESTNET_RPC?: string (private RPC URL)
BASE_TESTNET_FALLBACK_RPCS: string (comma-separated public RPCs)
BASE_TESTNET_CHAIN_ID: number
BASE_TESTNET_EXPLORER: string

// BSC Mainnet
BSC_MAINNET_RPC?: string (private RPC URL)
BSC_MAINNET_FALLBACK_RPCS: string (comma-separated public RPCs)
BSC_MAINNET_CHAIN_ID: number
BSC_MAINNET_EXPLORER: string

// BSC Testnet
BSC_TESTNET_RPC?: string (private RPC URL)
BSC_TESTNET_FALLBACK_RPCS: string (comma-separated public RPCs)
BSC_TESTNET_CHAIN_ID: number
BSC_TESTNET_EXPLORER: string
```

## üõ†Ô∏è Utility Functions

### Configuration Utilities
```typescript
import {
  getDatabaseConfig,
  getRedisConfig,
  getKafkaConfig,
  getJwtConfig,
  getServiceUrls,
  getNetworkConfigs,
  getTradingConfig,
  getApiKeys,
  getCacheConfig,
  validateServiceConfig,
  getServerConfig,
} from '@moonx/configs';

// L·∫•y config cho t·ª´ng service
const dbConfig = getDatabaseConfig('auth-service');
const redisConfig = getRedisConfig('aggregator-service');
const networks = getNetworkConfigs('swap-orchestrator');
```

### RPC Management Utilities
```typescript
import {
  getBestRpcUrl,
  getAllRpcUrls,
  getPublicRpcUrls,
  hasPrivateRpc,
  getRpcConfig,
} from '@moonx/configs';

// L·∫•y RPC URL t·ªët nh·∫•t
const bestUrl = getBestRpcUrl(networkConfig);

// L·∫•y t·∫•t c·∫£ RPC URLs (private tr∆∞·ªõc, fallback sau)
const allUrls = getAllRpcUrls(networkConfig);

// L·∫•y ch·ªâ public RPC URLs
const publicUrls = getPublicRpcUrls(networkConfig);

// Ki·ªÉm tra c√≥ private RPC kh√¥ng
const hasPrivate = hasPrivateRpc(networkConfig);

// L·∫•y RPC config ho√†n ch·ªânh
const rpcConfig = getRpcConfig('aggregator-service', 'base', 'mainnet');
```

## üîÑ Migration t·ª´ Common Package

### Tr∆∞·ªõc (Legacy)
```typescript
import { validateEnv, BaseEnvSchema } from '@moonx/common';

const AuthServiceEnvSchema = BaseEnvSchema.extend({
  PRIVY_APP_ID: z.string(),
  PRIVY_APP_SECRET: z.string(),
});

export const env = validateEnv(AuthServiceEnvSchema);
```

### Sau (Configs Package)
```typescript
import { createAuthServiceConfig } from '@moonx/configs';

const config = createAuthServiceConfig();
const privyAppId = config.get('PRIVY_APP_ID');
const privyAppSecret = config.get('PRIVY_APP_SECRET');
```

## üìù Environment Variables

### Blockchain RPC Configuration
```bash
# Base Mainnet
BASE_MAINNET_RPC=https://your-private-base-rpc.com
BASE_MAINNET_FALLBACK_RPCS=https://mainnet.base.org,https://base.blockpi.network/v1/rpc/public,https://1rpc.io/base,https://base.meowrpc.com
BASE_MAINNET_CHAIN_ID=8453
BASE_MAINNET_EXPLORER=https://basescan.org

# Base Testnet
BASE_TESTNET_RPC=https://your-private-base-testnet-rpc.com
BASE_TESTNET_FALLBACK_RPCS=https://sepolia.base.org,https://base-sepolia.blockpi.network/v1/rpc/public,https://base-sepolia.publicnode.com
BASE_TESTNET_CHAIN_ID=84532
BASE_TESTNET_EXPLORER=https://sepolia.basescan.org

# BSC Mainnet
BSC_MAINNET_RPC=https://your-private-bsc-rpc.com
BSC_MAINNET_FALLBACK_RPCS=https://bsc-dataseed1.binance.org,https://bsc-dataseed2.binance.org,https://bsc-dataseed3.binance.org,https://bsc-dataseed4.binance.org,https://bsc.nodereal.io
BSC_MAINNET_CHAIN_ID=56
BSC_MAINNET_EXPLORER=https://bscscan.com

# BSC Testnet
BSC_TESTNET_RPC=https://your-private-bsc-testnet-rpc.com
BSC_TESTNET_FALLBACK_RPCS=https://data-seed-prebsc-1-s1.binance.org:8545,https://data-seed-prebsc-2-s1.binance.org:8545,https://data-seed-prebsc-1-s2.binance.org:8545,https://data-seed-prebsc-2-s2.binance.org:8545
BSC_TESTNET_CHAIN_ID=97
BSC_TESTNET_EXPLORER=https://testnet.bscscan.com
```

## üöÄ Setup

### 1. Automated Setup
```bash
# Ch·∫°y script setup t·ª± ƒë·ªông
./scripts/setup-env.sh

# Script s·∫Ω:
# - T·∫°o .env t·ª´ env.example
# - Generate secure JWT/session secrets
# - Prompt cho database, Redis, Kafka config
# - T·∫°o environment-specific files
```

### 2. Manual Setup
```bash
# Copy environment template
cp env.example .env

# ƒêi·ªÅn c√°c gi√° tr·ªã th·ª±c t·∫ø
nano .env

# Install dependencies
pnpm install

# Build packages
pnpm build
```

## üîí Security Best Practices

1. **Private RPC URLs**: S·ª≠ d·ª•ng private RPC cho production
2. **Fallback RPCs**: Lu√¥n c√≥ fallback RPCs cho reliability
3. **Environment Separation**: S·ª≠ d·ª•ng different configs cho dev/staging/prod
4. **Secret Management**: Kh√¥ng commit secrets v√†o version control
5. **Validation**: Lu√¥n validate environment variables v·ªõi Zod schemas

## üìö Examples

Xem file `example.ts` ƒë·ªÉ c√≥ th√™m examples chi ti·∫øt v·ªÅ:
- Basic network configuration
- RPC utilities usage
- Service-specific RPC usage
- Environment-specific configuration
- Fallback RPC implementation 

## Logger Configuration

The system includes centralized logger configuration with the following features:

### Environment Variables

```bash
# Log level (error, warn, info, debug)
LOG_LEVEL=info

# Enable console logging
LOG_ENABLE_CONSOLE=true

# Enable file logging (recommended for production)
LOG_ENABLE_FILE=false

# Log directory
LOG_DIR=logs

# Maximum number of log files to keep
LOG_MAX_FILES=5

# Maximum size of each log file (e.g., 10m, 100m, 1g)
LOG_MAX_SIZE=10m

# Log format (json, console)
LOG_FORMAT=console
```

### Usage Examples

```typescript
import { createLogger, createLoggerForProfile, createLoggerWithConfig, LoggerConfig } from '@moonx/common';

// Basic usage with default configuration
const logger = createLogger('auth-service');
logger.info('Service started', { port: 3001 });

// Profile-based configuration (recommended)
const authLogger = createLoggerForProfile('auth-service');
authLogger.info('Auth service started', { port: 3001 });

const aggregatorLogger = createLoggerForProfile('aggregator-service');
aggregatorLogger.debug('Aggregator calculation started', { 
  tokenIn: 'USDC', 
  tokenOut: 'ETH',
  amount: '1000'
});

// Custom configuration
const customConfig: LoggerConfig = {
  level: 'debug',
  service: 'aggregator-service',
  enableConsole: true,
  enableFile: true,
  logDir: 'logs/aggregator',
  maxFiles: 10,
  maxSize: '20m',
  format: 'json',
};

const customLogger = createLoggerWithConfig(customConfig);

// Environment-specific configuration
const getLoggerForEnvironment = (service: string) => {
  const isProduction = process.env.NODE_ENV === 'production';
  
  const config: LoggerConfig = {
    level: isProduction ? 'info' : 'debug',
    service,
    enableConsole: !isProduction,
    enableFile: isProduction,
    logDir: 'logs',
    maxFiles: isProduction ? 10 : 5,
    maxSize: isProduction ? '50m' : '10m',
    format: isProduction ? 'json' : 'console',
  };
  
  return createLoggerWithConfig(config);
};

// Child logger with context
const userLogger = authLogger.child({ userId: 'user123' });
userLogger.info('User action performed', { action: 'login' });
```

### Features

- **Profile-based**: Each service can have its own logger configuration
- **Environment-aware**: Different settings for development, staging, and production
- **Flexible output**: Console and/or file logging
- **Structured logging**: JSON format for production, colored console for development
- **Context support**: Child loggers with default context
- **Performance timing**: Built-in timing utilities
- **Error handling**: Automatic error logging with context

## Environment Variables 